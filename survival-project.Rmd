---
title: "Math 150 Survival Analysis Project"
author: "Carrie Saada"
date: "April 8, 2019"
output:
  pdf_document: default
  html_document: default
---

```{r global_options, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, fig.height=4, fig.width=5, 
                      fig.align = "center")
library(tidyverse)
library(broom)
library(survival)
library(survminer)
```

#Outline of "Something New"#

For my "something new", I will do a power analysis of the model. I will perform this analysis via simulation by randomly generating a dataset where the null hypothesis is false - there is a difference between the treatment groups. I think it will be useful to look at the power to distinguish between treatment and control, and between all 4 treatment groups (would we be able to distinguish IDV having an effect on survival in the ZDV + 3TC + IDV group, but not in the d4T + 3TC + IDV group?)  

The power analysis of the model is relevant to this survival analysis model because it is useful to know whether our model can reject the null hypothesis when it is warranted. If the model is not very powerful and we fail to reject the null hypothesis, it may be a good idea to continue research with a larger sample size. Or, if the model is powerful and we fail to reject the null hypothesis, we can say that if there were a true difference, our model would probably have detected it, so it may not be worth continuing the research. 

I'm going to use the class textbook and *The Analysis of Biological Data* by Whitlock and Schluter (2015) to learn about power and how it relates to sample and effect size. I will also read published articles such as Cohen 1992 adn Dorey 2011 (see working bibliography). 

This will be challenging because I need to learn how to apply power analysis to an experiment that has already been completed, rather than to determine an ideal sample size. Additionally, I will need to learn how to do power analysis simulations for survival data - how do I generate realistic survival data? What variables do I include? How do I handle effect size? What about censoring?

#Working Bibliography#

Cohen, Jacob. “Statistical Power Analysis.” Current Directions in Psychological Science, vol. 1, no. 3, June 1992, pp. 98–101. SAGE Journals, doi:10.1111/1467-8721.ep10768783.

Dorey, Frederick J. “In Brief: Statistics in Brief: Statistical Power: What Is It and When Should It Be Used?” Clinical Orthopaedics and Related Research, vol. 469, no. 2, Feb. 2011, pp. 619–20. PubMed Central, doi:10.1007/s11999-010-1435-0.

Kuiper, Shonda, and Jeffrey Sklar. Practicing Statistics : Guided Investigations for the Second Course. Pearson, 2013.

Whitlock, Michael, and Dolph Schluter. The Analysis of Biological Data. Second ed., Roberts and Company, 2015.


#Importing data:#

```{r}
AD = read.csv("AIDSdata.csv")
```

#Some exploratory plots:#

```{r}
hist(AD$cd4, main = "Histogram of CD4 counts", xlab = "number of cd4 t-cells")
hist(AD$karnof, main = "Histogram of Karnof scores", xlab = "Karnoff score", breaks = 5)
#I'm having a hard time getting the histogram breaks right - karnoff scores are multiples of 10 and it doesn't like that
plot(AD$age, AD$karnof, main = "plot of karnof score vs age")
plot(AD$cd4, AD$time, main ="time vs cd4 count, ignoring censoring")
```


##Working on COX model

Variables: 
Response: time, censor
Not using: time.d, censor.d (because we're using "aids defining event or death", not just death)
Explanatory: tx, txgrp, strat2, sex, raceth, ivdrug, hemophil, karnof, cd4, priorzdv, age


Let's check if we need interaction. Likelihood ratio test is 2ln(Likelihood of full) - 2ln(Likelihood of reduced)

```{r}
full = coxph(Surv(time, censor) ~ (tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age)^2, data = AD) 
full$loglik[2]
red = coxph(Surv(time, censor) ~ tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age, data = AD) 
red$loglik[2]
length(red$coefficients)
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2], df = length(full$coefficients) - length(red$coefficients))
full
```

This is close enough to 0.05 that I'm not comfortable eliminating interaction.  

lets eliminiate hemophil entirely

```{r}
full = coxph(Surv(time, censor) ~ (tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age)^2, data = AD) 
full$loglik[2]
red = coxph(Surv(time, censor) ~ (tx+strat2+sex+raceth+ivdrug+karnof+cd4+priorzdv+age)^2, data = AD) 
red$loglik[2]
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
#red

```


We can eliminate hemophil entirely. Let's try that with strat 2

```{r}
full = coxph(Surv(time, censor) ~ (tx+strat2+sex+raceth+ivdrug+karnof+cd4+priorzdv+age)^2, data = AD) 
full$loglik[2]
red = coxph(Surv(time, censor) ~ (tx+sex+raceth+ivdrug+karnof+cd4+priorzdv+age)^2, data = AD) 
red$loglik[2]
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
red

```

Okay let's eliminate anything with a p-value of 0.1 or larger. 

```{r}
full = coxph(Surv(time, censor) ~ (tx+sex+raceth+ivdrug+karnof+cd4+priorzdv+age)^2, data = AD)  
full$loglik[2]
red = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*(sex + karnof + age) + ivdrug*(karnof + priorzdv) + karnof*age + cd4, data = AD) 
red$loglik[2]
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
red

```

We can do that, so let's eliminate karnof$*$age and karnof$*$ivdrug

```{r}
full = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*(sex + karnof + age) + ivdrug*(karnof + priorzdv) + karnof*age + cd4, data = AD)
full$loglik[2]
red = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*(sex + karnof + age) + ivdrug*priorzdv + cd4, data = AD) 
red$loglik[2]
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
red

```

Let's try raceth$*$age

```{r}
full = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*sex + raceth*karnof + raceth*age + ivdrug*priorzdv + cd4, data = AD) 
full$loglik[2]
red = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*sex + raceth*karnof + ivdrug*priorzdv + cd4, data = AD)
red$loglik[2]
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
red
```

Let's try raceth$*$karnof

```{r}
full = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*sex + raceth*karnof + ivdrug*priorzdv + cd4, data = AD) 
full$loglik[2]
red = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*sex + karnof + ivdrug*priorzdv + cd4, data = AD)
red$loglik[2]
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
red
```

Okay all the interaction terms are now below 0.05 and the only p-values above 0.05 are variables that are also in interaction terms. So, I have a model. Let's check against the full model with all interaction just to be sure. 
 
```{r}
full = coxph(Surv(time, censor) ~ (tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age)^2, data = AD) 
red = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*sex + ivdrug*priorzdv + karnof + cd4, data = AD)
1 - pchisq(2 * full$loglik[2] - 2 * red$loglik[2] , df = length(full$coefficients) - length(red$coefficients))
```

Alright that works then. 

The model is:

```{r}
model = coxph(Surv(time, censor) ~ tx*(sex + priorzdv) + raceth*sex + ivdrug*priorzdv + karnof + cd4, data = AD)
model
```





